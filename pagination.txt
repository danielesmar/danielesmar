WITH total_registros AS (
    -- Llama a tu funci칩n de conteo de registros para obtener el total
    SELECT ContarIncidencias(:P_FILTRAR_USUARIO, :P_FEC_INICIO, :P_FEC_FINAL, :P_ID) AS total_rows FROM dual
),
total_paginas AS (
    SELECT CEIL(total_rows / :P_PAGE_SIZE) AS total_pages FROM total_registros
),
bloque_actual AS (
    SELECT
        FLOOR((:P_PAGE_NUMBER - 1) / 10) AS block_number,
        (FLOOR((:P_PAGE_NUMBER - 1) / 10) * 10) + 1 AS start_page,
        LEAST((FLOOR((:P_PAGE_NUMBER - 1) / 10) * 10) + 10, (SELECT total_pages FROM total_paginas)) AS end_page
    FROM dual
),
botones AS (
    -- Bot칩n para el bloque Anterior
    SELECT
        1 AS button_order,
        'Anterior' AS button_label,
        (SELECT start_page FROM bloque_actual) - 10 AS target_page,
        'previous' AS button_type
    FROM dual
    WHERE (SELECT start_page FROM bloque_actual) > 1
    
    UNION ALL
    
    -- Botones numerados de la p치gina
    SELECT
        2 AS button_order,
        TO_CHAR(LEVEL) AS button_label,
        LEVEL AS target_page,
        'page_number' AS button_type
    FROM dual
    CONNECT BY LEVEL BETWEEN (SELECT start_page FROM bloque_actual) AND (SELECT end_page FROM bloque_actual)
    
    UNION ALL
    
    -- Bot칩n para el bloque Siguiente
    SELECT
        3 AS button_order,
        'Siguiente' AS button_label,
        (SELECT end_page FROM bloque_actual) + 1 AS target_page,
        'next' AS button_type
    FROM dual
    WHERE (SELECT end_page FROM bloque_actual) < (SELECT total_pages FROM total_paginas)
)
SELECT
    CASE
        WHEN button_type = 'page_number' THEN
            CASE
                WHEN button_label = TO_CHAR(:P_PAGE_NUMBER) THEN '<span class="current-page">' || button_label || '</span>'
                ELSE '<a href="' || APEX_UTIL.PREPARE_URL(
                    p_url => 'f?p=' || :APP_ID || ':' || :APP_PAGE_ID || ':' || :APP_SESSION || '::NO::P' || :APP_PAGE_ID || '_PAGE_NUMBER:' || target_page
                ) || '" class="pagination-link">' || button_label || '</a>'
            END
        ELSE
            '<a href="' || APEX_UTIL.PREPARE_URL(
                p_url => 'f?p=' || :APP_ID || ':' || :APP_PAGE_ID || ':' || :APP_SESSION || '::NO::P' || :APP_PAGE_ID || '_PAGE_NUMBER:' || target_page
            ) || '" class="pagination-link">' || button_label || '</a>'
    END AS paginacion_link
FROM botones
ORDER BY button_order, target_page;
